**Purpose**: Short guide for AI coding agents working on this repo — focused, actionable details to get productive quickly.

**Big Picture**: This repository contains an Anchor (Rust) on-chain program and a Node.js server that coordinates off-chain game registration and settlement for a simple wager game.
- **On-chain program**: `programs/trex_wager/` implements `initialize_game`, `settle_game`, `cancel_game` and stores `GameState` (see `src/lib.rs`). The program ID is declared in the Rust `declare_id!(...)` and mirrored in `Anchor.toml`.
- **Server**: `server/index.js` loads the program IDL at `target/idl/trex_wager.json`, uses a local Authority keypair (`server/authority.json` by default), and exposes HTTP endpoints (`/api/register_game`, `/api/settle`, `/api/games`).
- **Frontend & tests**: The preferred frontend is a Next.js app under `frontend/` (see `frontend/README.md`). The server still exposes REST endpoints used by the UI; the old static frontend in the repo root was removed.

**Key files to inspect**:
- `programs/trex_wager/src/lib.rs` — core program logic and account layout (GameState fields: `player, wager, escrow, settled, nonce`).
- `programs/trex_wager/idl.json` and `target/idl/trex_wager.json` — IDL format the server expects (generated by `anchor build`).
- `server/index.js` — server logic, IDL loading, wallet wrapper (`NodeWallet`), endpoints and PDA derivation logic for games.
- `Anchor.toml` — cluster and program id configured for Anchor; `declare_id!` in Rust must match Anchor.toml/program id for local dev.
- `README.md` — high level run steps (devnet flow).

**Build / Run / Deploy (concrete commands)**:
- Install Solana + Anchor (follow Anchor docs).
- Build program & generate IDL: `cd programs/trex_wager && anchor build` (IDL appears under `target/idl/trex_wager.json`).
- Deploy (devnet as used in Anchor.toml): `anchor deploy --provider.cluster devnet` (or `anchor deploy` if configured).
- Start server: `cd server && npm install && PROGRAM_ID=<programId> AUTHORITY_KEYPAIR=./server/authority.json npm start` (server also reads `process.env.SOLANA_CLUSTER`).
-- Preferred frontend (Next.js): `cd frontend && npm install && NEXT_PUBLIC_SERVER_BASE=http://localhost:3000 NEXT_PUBLIC_PROGRAM_ID=<programId> npm run dev`.

**Server-specific expectations / conventions**:
- IDL must be present at `target/idl/trex_wager.json` relative to `server/index.js` — if missing, server exits with a helpful error.
- Authority keypair: server expects `server/authority.json` (default) and will exit if not present; generate with `solana-keygen new --outfile ./server/authority.json`.
- Program ID lookup: server uses `process.env.PROGRAM_ID` or falls back to the Program ID in the IDL. Update `Anchor.toml` and the front-end `app.js` consistently.
- PDA derivation: registration uses `PublicKey.findProgramAddressSync([Buffer.from('game'), <playerPubkey>, nonce], programId)` — maintain the same seed choices when writing client code.
- Amounts: server sends `winnerAmount` and `adminAmount` into `program.methods.settleGame(new BN(winnerAmount), new BN(adminAmount))` and maps accounts per IDL. Preserve the account ordering and names.

**Patterns & code conventions**:
- On-chain accounts that only receive lamports are modeled as `UncheckedAccount` in Rust (`escrow`, `winner`, `admin`) — the program transfers lamports directly rather than manipulating account data.
- `GameState` sizing: `init` uses `space = 8 + 32 + 8 + 32 + 1 + 1` — keep serialized size in mind when adding fields.
- Error handling: program uses Anchor `require!` macros and `#[error_code]` enum (`TrexError`). Match these messages in server logs for debugging.

**Typical HTTP payload examples**:
- Register game (server): POST `/api/register_game` with JSON { "player": "<playerPubkey>", "escrow": "<escrowPubkey>", "wager": <lamports>, "nonce": <nonce> }
- Settle (server): POST `/api/settle` with JSON { "gamePubkey": "<pda>", "winner": "<pubkey>", "winnerAmount": <u64>, "adminAmount": <u64> }

**Debugging tips**:
- If server logs `IDL not found at target/idl/trex_wager.json`, run `anchor build` from the program dir and ensure `target/idl/trex_wager.json` exists.
- If authority keypair missing: follow the message in `server/index.js` and create a keypair. Never commit private key files — `authority.json` should be kept out of git.
- Verify deployed program id: after `anchor deploy`, check the `declare_id!` in `src/lib.rs` and the `Anchor.toml` entry — mismatches cause runtime failures.
- Use `solana logs --url <cluster>` while testing transactions to observe on-chain errors.

**Security & ops notes**:
- The repository includes a devnet test keypair file (`authority.json`) — treat as sensitive and do not publish to production.
- Escrow accounts are Unchecked and hold lamports; ensure transfer logic and expected balances are validated before calling `settle_game`.

**What to change when modifying the program**:
- Update `src/lib.rs` and bump version in IDL by running `anchor build` so `target/idl/*.json` is regenerated.
- If you change account layouts, update the JS server calls (account names/order) and the frontend to match the new IDL.

If anything here is unclear or you want more examples (curl commands, test harness, or a small integration test), tell me which part to expand and I will update this file.
